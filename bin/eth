#!/usr/bin/env node

var eth = require('../lib');

function ethEval(code, env, filename, callback) {
  try {
    var result = eth.eval(env, eth.read(filename, code));
    callback(null, result);
  } catch(e) {
    callback(e);
  }
}

function repl() {
  var repl = require('repl').start({
    prompt: 'eth> ',
    eval: ethEval
  });
  ethEval('(import "../core" (..))', repl.context, 'repl', function(err) {
    if (err) throw err;
  });
}

function compile(filename, onlyAst) {
  var sourceCode = require('fs').readFileSync(filename, 'utf8');
  var ast = eth.read(filename, sourceCode);
  if (onlyAst) {
    function astToString(astNode) {
      if ('nodes' in astNode) {
        return astNode.nodes.map(astToString);
      } else {
        return '[' + astNode.type + '|' + astNode.value + ']';
      }
    }
    return JSON.stringify(astToString(ast), null, 2);
  } else {
    return eth.write(ast);
  }
}

function help() {
  console.log([
    'Eth Usage:',
    '  eth                            run repl',
    '  eth file.eth                   compile and run file',
    '  eth [-h|--help]                show this message',
    '  eth [-c|--compile] file.eth    compile file to JS',
    '  eth [-a|--ast] file.eth        show file AST/tokens',
    ''
  ].join('\n'));
}

var args = process.argv.slice(2);
if (args.length === 0) {
  repl();
} else if (args[0] === '-h' || args[0] === '--help') {
  help();
} else if ((args[0] === '-a' || args[0] === '--ast') && args.length === 2) {
  console.log(compile(args[1], true));
} else if ((args[0] === '-c' || args[0] === '--compile') && args.length === 2) {
  console.log(compile(args[1]));
} else if (args.length === 1) {
  var result = eval(compile(args[0]));
  if (typeof result !== 'undefined') {
    console.log(result);
  }
} else {
  help();
}
